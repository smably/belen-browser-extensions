<html>
<head>
	<title>Belen Bookmarklets</title>

	<script type="text/javascript">
	// Here are the human-readable versions of the bookmarklets below, included for the benefit of any future hackers who may wish to extend or modify them.
	// The bookmarklets are essentially this code, run through a minifier. I have made a couple of minor changes here for the sake of readability:
	//   * I have added semicolons at the end of each statement
	//   * Some long strings have been broken up onto multiple lines
	// Original code by Sylvan Mably (sylvan@gumtree.com).
		
		// Make the keyword field accept 200 characters (instead of 20) and turn it green as a hint to the user
		function extendKeywordField() {
			if (location['host'] + location['pathname'] == 'cs.gumtree.com.au/searchAds.do') {

				// If an element exists with id "srch-kwrd", set its max length to 200 and its background colour to green
				var k = $('#srch-kwrd');
				if (k) {
					k.attr('maxlength', '200');
					k.css('background-color', '#DFD');
				}
			}
		}

		// Add links to the ad ID, machine ID, and phone number for each ad
		function linkify() {
			if (location['host'] + location['pathname'] == 'cs.gumtree.com.au/searchAds.do') {

				// Add links inside elements that do not already have links and return any elements to which links were added
				var w = function(e) { return e.not(e.has('a')).wrapInner('<a>') };

				// Remove the link cursor from the user history line
				$('.meta-user-history').css('cursor', '');

				// TODO: Break this up onto multiple lines and document more thoroughly
				// Wrap the text of each of the spans in the user history box in link tags
				// Apply the span class to child link tags to preserve link colour
				// Add the link href attributes according to the class of the element and the text in the email field
				// Add target "_blank" to force links to open in a new window
				w($('span.meta-usrads-pstd,span.meta-usrads-ok,span.meta-usrads-bad')).find('a').addClass(function() { return $(this).parent().attr('class'); }).attr('href', function() { var p = ''; if ($(this).hasClass('meta-usrads-bad')) { p = '&searchRequest.groupedAdState=BLOCKED&searchRequest.groupedAdState=BLOCK_ADMIN_CONFIRMED&searchRequest.groupedAdState=DELETED__ADMIN_DELETED'; } else if ($(this).hasClass('meta-usrads-ok')) { p = '&searchRequest.groupedAdState=DELAYED&searchRequest.groupedAdState=ACTIVE__TNS_SCORE_FILTER&searchRequest.groupedAdState=ACTIVE__ADMIN_REVIEWED&searchRequest.groupedAdState=ACTIVE__DELAYED_TIMEOUT'; } return '?formAction=submitSearch&searchRequest.dateRangeType=NO_RANGE' + p + '&idAndEmailField=' + $(this).closest('.p-ads-dl').find('.meta-email :first-child').text(); }).attr('target', '_blank');

				// Add some informative titles on the new links
				$('a.meta-usrads-pstd').attr('title', 'View all ads from this user');
				$('a.meta-usrads-ok').attr('title', 'View live and delayed ads from this user');
				$('a.meta-usrads-bad').attr('title', 'View blocked and admin deleted ads from this user');
				
				// TODO: Break this up onto multiple lines and document more thoroughly
				// Find the parent elements of the ad ID, machine ID, and phone number, wrap their contents in link tags
				// Set the href and target attributes on all links according to what kind of link they are (TODO: document this more thoroughly)
				// Add blocked class onto all links inside a blocked dd (preserves red highlighted on blocked machine IDs)
				w($('dt:contains(\'Ad-Id:\') + dd,dt:contains(\'Machine Id:\') + dd div,dt:contains(\'Phone:\') + dd')).find('a').attr('href', function() { var t = $(this).closest('dd').prev('dt').text(); var p; if (t == 'Ad-Id:') { p = '&idAndEmailField='; } else if (t == 'Machine Id:') { p = '&machId='; } else { p = '&searchRequest.keyword='; } return '?formAction=submitSearch&searchRequest.dateRangeType=LAST_MONTH' + p + $(this).text(); }).attr('target', '_blank').filter('dd.p-ads-dd-blocked a').addClass('p-ads-dd-blocked');

			}
		}

		// Highlight ads from first-time posters and colour-code user state
		function hlUserRisks() {
			if (location['host'] + location['pathname'] == 'cs.gumtree.com.au/searchAds.do') {

				// Find all adRow tr elements that have a child element of class "meta-usrads-pstd" in which the text is precisely "1"
				// To those matching tr elements, apply a blue background colour (these are our first-time posters)
				$('tr.adRow').has($('.meta-usrads-pstd').filter(function() { return $(this).text() == '1'; })).css('background-color', '#E3EDFA');

				// Highlight all scores in red, unless they're 0, in which case make them green
				$('dd.meta-scr').css('padding', '1px').css('background-color', '#FCB').filter(function() { return $(this).text().trim() == '0'; }).css('background-color', '#CEB');

				// Highlight live (tested) ad status in green
				$('.meta-status:contains(\'Live \(Tested\)\')').css('background-color', '#CEB');

				// Highlight, live (untested), blocked, and deleted ad status in red
				$('.meta-status:contains(\'Live \(Untested\)\'),.meta-status:contains(\'Blocked\'),.meta-status:contains(\'Deleted \(Admin\)\')').css('background-color', '#FCB');

				// Make phone numbers green
				$('dt:contains(\'Phone:\') + dd').css('background-color', '#CEB');
						
				// Give active, registered users a green background colour and everyone else red
				$('dd.meta-user-status').css('background-color', '#FCB').filter('dd.meta-user-status:contains(\'Active \(User\), Registered\')').css('background-color', '#CEB');

				// Change background colour of email address matching regex r to colour c
				var f = function(r, c) { $('.meta-email :first-child').filter(function() { return r.test( $(this).text() ); }).css('padding', '1px').css('background-color', c) };

				// Highlight freemail domains in red
				f(/@(aol\.|gmx\.|g?(oogle)?mail\.com|hotmail\.|msn\.com|naver\.com|qq\.com|(windows)?live\.|y7?mail\.com|yahoo\.)/i, '#FCB');

				// Highlight ISP domains in green
				f(/@(.+\.edu.au|aapt\.net\.au|bigpond\.(com|net)(\.au)?|dodo\.com\.au|iinet\.net\.au|intas\.net\.au|internode\.on\.net|iprimus\.com\.au|netspace\.net\.au|optusnet\.com\.au|ozemail\.com\.au|tadaust\.org\.au|tpg\.com\.au|uplink.net.au|virginbroadband.com.au|westnet\.com\.au)$/i, '#CEB');

				// Highlight users with at least one ok ad in green
				$('dd.meta-user-history').has($('.meta-usrads-ok').filter(function() { return $(this).text() != '0'; })).css('padding', '1px').css('background-color', '#CEB');

				// Highlight users with at least one bad ad in red
				$('dd.meta-user-history').has($('.meta-usrads-bad').filter(function() { return $(this).text() != '0'; })).css('padding', '1px').css('background-color', '#FCB');

			}
		}

		// Open a window with the current search parameters embedded in the query string
		function createSearchPermalink() {
			if (location['host'] + location['pathname'] == 'cs.gumtree.com.au/searchAds.do') {

				// Open a window with the Belen search URL, followed by...
				window.open('http://cs.gumtree.com.au/searchAds.do?formAction=submitSearch&' +

					// ...the serialization of all inputs under the searchForm from the set of fields we care about
					// (Discarding any with the blank or default value, as we want to minimize the length of the URL)
					$('#searchForm :' +
						'[name=\'categoryId1stLevel\'],' + 
						'[name=\'categoryId2ndLevel\'][value!=\'\'],' +
						'[name=\'searchRequest.scoreGroups\'],' +
						'[name=\'searchRequest.activeFeatureTypes\'],' +
						'[name=\'purchaseOrderId\'][value!=\'\'],' +
						'[name=\'searchRequest.groupedAdState\'],' +
						'[name=\'searchRequest.dateRangeType\'][value!=\'LAST_WEEK\'],' +
						'[name=\'idAndEmailField\'][value!=\'\'],' +
						'[name=\'machId\'][value!=\'\'],' +
						'[name=\'paymentTransactionId\'][value!=\'\'],' +
						'[name=\'searchRequest.ip\'][value!=\'\'],' +
						'[name=\'searchRequest.keyword\'][value!=\'\'],' +
						'[name=\'searchRequest.agent\'][value!=\'\'],' +
						'[name=\'searchRequest.flagType\'][value!=\'\'],' +
						'[name=\'searchRequest.appealType\'][value!=\'IGNORE\']'
					).serialize()
				);
			}
		}

	</script>

</head>
<body>

	<h1>Belen Bookmarklets</h1>

	<p>Drag the following links onto your bookmarks bar to use while in Belen:

	<ul>
		<li><a href="javascript:(function(){if(location['host']+location['pathname']=='cs.gumtree.com.au/searchAds.do'){window.open('http://cs.gumtree.com.au/searchAds.do?formAction=submitSearch&'+$('#searchForm :[name=\'categoryId1stLevel\'],[name=\'categoryId2ndLevel\'][value!=\'\'],[name=\'searchRequest.scoreGroups\'],[name=\'searchRequest.activeFeatureTypes\'],[name=\'purchaseOrderId\'][value!=\'\'],[name=\'searchRequest.groupedAdState\'],[name=\'searchRequest.dateRangeType\'][value!=\'LAST_WEEK\'],[name=\'idAndEmailField\'][value!=\'\'],[name=\'machId\'][value!=\'\'],[name=\'paymentTransactionId\'][value!=\'\'],[name=\'searchRequest.ip\'][value!=\'\'],[name=\'searchRequest.keyword\'][value!=\'\'],[name=\'searchRequest.agent\'][value!=\'\'],[name=\'searchRequest.flagType\'][value!=\'\'],[name=\'searchRequest.appealType\'][value!=\'IGNORE\']').serialize())}})()">Belen search permalink</a>
		<li><b><a href="javascript:(function(){if(location['host']+location['pathname']=='cs.gumtree.com.au/searchAds.do'){var k=$('#srch-kwrd');if(k){k.attr('maxlength','200').css('background-color','#DFD')};var w=function(e){return e.not(e.has('a')).wrapInner('<a>')};$('.meta-user-history').css('cursor','');w($('span.meta-usrads-pstd,span.meta-usrads-ok,span.meta-usrads-bad')).find('a').addClass(function(){return $(this).parent().attr('class')}).attr('href',function(){var p='';if($(this).hasClass('meta-usrads-bad')){p='&searchRequest.groupedAdState=BLOCKED&searchRequest.groupedAdState=BLOCK_ADMIN_CONFIRMED&searchRequest.groupedAdState=DELETED__ADMIN_DELETED'}else if($(this).hasClass('meta-usrads-ok')){p='&searchRequest.groupedAdState=DELAYED&searchRequest.groupedAdState=ACTIVE__TNS_SCORE_FILTER&searchRequest.groupedAdState=ACTIVE__ADMIN_REVIEWED&searchRequest.groupedAdState=ACTIVE__DELAYED_TIMEOUT'}return'?formAction=submitSearch&searchRequest.dateRangeType=NO_RANGE'+p+'&idAndEmailField='+$(this).closest('.p-ads-dl').find('.meta-email :first-child').text()}).attr('target','_blank');$('a.meta-usrads-pstd').attr('title','View all ads from this user');$('a.meta-usrads-ok').attr('title','View live and delayed ads from this user');$('a.meta-usrads-bad').attr('title','View blocked and admin deleted ads from this user');w($('dt:contains(\'Ad-Id:\') + dd,dt:contains(\'Machine Id:\') + dd div,dt:contains(\'Phone:\') + dd')).find('a').attr('href',function(){var t=$(this).closest('dd').prev('dt').text();var p;if(t=='Ad-Id:'){p='&idAndEmailField='}else if(t=='Machine Id:'){p='&machId='}else{p='&searchRequest.keyword='}return'?formAction=submitSearch&searchRequest.dateRangeType=LAST_MONTH'+p+$(this).text()}).attr('target','_blank').filter('dd.p-ads-dd-blocked a').addClass('p-ads-dd-blocked');$('tr.adRow').has($('.meta-usrads-pstd').filter(function(){return $(this).text()=='1'})).css('background-color','#E3EDFA');$('dd.meta-user-status:contains(\', Unregistered\')').css('background-color','#FCC');$('dd.meta-user-status:contains(\', Registered\')').css('background-color','#CEC')}})()">Belen++ 1.1</a></b>

		<!-- These three are included in Belen++. There's not much point keeping them around as individual bookmarklets, but I have preserved them for posterity nonetheless. Move along, folks, nothing to see here. -->
		<!--
		<li><a href="javascript:(function(){if(location['host']+location['pathname']=='cs.gumtree.com.au/searchAds.do'){var k=$('#srch-kwrd');if(k){k.attr('maxlength','200');k.css('background-color','#DFD')}}})()">Extend keyword field</a>
		<li><a href="javascript:(function(){if(location['host']+location['pathname']=='cs.gumtree.com.au/searchAds.do'){$('dt:contains(\'Ad-Id:\') + dd').html(function(i,v){if(v.charAt(0)=='<'){return v}else{return'<a href=\'?formAction=submitSearch&idAndEmailField='+v+'\' target=\'_blank\'>'+v+'</a>'}});$('dt:contains(\'Machine Id:\') + dd div').html(function(i,v){if(v.charAt(0)=='<'){return v}else{return'<a href=\'?formAction=submitSearch&searchRequest.dateRangeType=LAST_MONTH&machId='+v+'\' target=\'_blank\'>'+v+'</a>'}});$('dt:contains(\'Phone:\') + dd').html(function(i,v){if(v.charAt(0)=='<'){return v}else{return'<a href=\'?formAction=submitSearch&searchRequest.dateRangeType=LAST_MONTH&searchRequest.keyword='+v+'\' target=\'_blank\'>'+v+'</a>'}})}})()">Linkify machine ID</a>
		<li><a href="javascript:(function(){if(location['host']+location['pathname']=='cs.gumtree.com.au/searchAds.do'){$('tr.adRow').has($('.meta-usrads-pstd').filter(function(){return $(this).text()=='1'})).filter($('tr.adRow').has($('dd.meta-user-status:contains(\'Unregistered\')'))).css('background-color','#FAA')}})()">Highlight new+unreg</a>
		-->

		<!-- And yeahhh... This one is kind of questionable. It works (ish) but definitely needs a bit more time in the oven. -->
		<!--
		<li><a href="javascript:(function(){if(location['host']+location['pathname']=='cs.gumtree.com.au/searchAds.do'){$('a.a-adimg').attr('href',function(i,val){return val.replace('_23','_20')})}})()">Show larger images</a>
		-->

	</ul>

</body>
</html>
